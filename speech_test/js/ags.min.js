L.AGS=L.Class.extend({});L.AGS.Layer=L.Class.extend({includes:L.Mixin.Events});L.AGS.Layer.Dynamic=L.ImageOverlay.extend({defaultParams:{format:"png8",transparent:!0,f:"image",bboxSR:102100},initialize:function(b,a,c){this._url=b;this._bounds=L.latLngBounds(a);this._layerParams=L.Util.extend({},this.defaultParams);for(var d in c)this.options.hasOwnProperty(d)||(this._layerParams[d]=c[d]);delete this._layerParams.token;this._parseLayers();this._parseLayerDefs();L.Util.setOptions(this,c)},onAdd:function(b){this._map=b;this._image||this._initImage();b._panes.overlayPane.appendChild(this._image);
b.on({viewreset:this._reset,moveend:this._update},this);if(b.options.zoomAnimation&&L.Browser.any3d)b.on("zoomanim",this._animateZoom,this);this._reset();this._update()},onRemove:function(b){b.getPanes().overlayPane.removeChild(this._image);b.off({viewreset:this._reset,moveend:this._update},this);b.options.zoomAnimation&&b.off("zoomanim",this._animateZoom,this)},_parseLayers:function(){if("undefined"===typeof this._layerParams.layers)delete this._layerParams.layerOption;else{var b=this._layerParams.layerOption||
null,a=this._layerParams.layers||null,c="show",d=["show","hide","include","exclude"];delete this._layerParams.layerOption;if(b)-1!=d.indexOf(b)&&(c=b),this._layerParams.layers=c+":"+a;else if(a instanceof Array)this._layerParams.layers=c+":"+a.join(",");else if("string"===typeof a){if(b=a.match(":"))a=a.split(b[0]),Number(a[1].split(",")[0])&&(-1!=d.indexOf(a[0])&&(c=a[0]),a=a[1]);this._layerParams.layers=c+":"+a}}},_parseLayerDefs:function(){if("undefined"!==typeof this._layerParams.layerDefs){var b=
this._layerParams.layerDefs,a=[];if(b instanceof Array)for(var c=b.length,d=0;d<c;d++)b[d]&&a.push(d+":"+b[d]);else if("object"===typeof b)for(c in b)a.push(c+":"+b[c]);else{delete this._layerParams.layerDefs;return}this._layerParams.layerDefs=a.join(";")}},_initImage:function(){this._image=L.DomUtil.create("img","leaflet-image-layer");this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._image,"leaflet-zoom-animated"):L.DomUtil.addClass(this._image,"leaflet-zoom-hide");this._updateOpacity();
L.Util.extend(this._image,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.Util.bind(this._onImageLoad,this),src:this._getImageUrl()})},_getImageUrl:function(){var b=this._map.getBounds(),a=this._map.getSize(),c=this._map.options.crs.project(b._northEast),b=this._map.options.crs.project(b._southWest);this._layerParams.bbox=[b.x,b.y,c.x,c.y].join();this._layerParams.size=a.x+","+a.y;a=this._url+"/export"+L.Util.getParamString(this._layerParams);"undefined"!==typeof this.options.token&&
(a=a+"&token="+this.options.token);return a},_update:function(){if(!this._map._panTransition||!this._map._panTransition._inProgress){var b=this._map.latLngToLayerPoint(this._map.getBounds().getNorthWest()),a=this._map.latLngToLayerPoint(this._map.getBounds().getSouthEast())._subtract(b),c=this._map.getZoom();c>this.options.maxZoom||c<this.options.minZoom||(this._image.style.display="none",this._image.src=this._getImageUrl(),L.DomUtil.setPosition(this._image,b),this._image.style.width=a.x+"px",this._image.style.height=
a.y+"px")}},_onImageLoad:function(){this._image.style.display="block"}});L.agsDynamicLayer=function(b,a,c){return new L.AGS.Layer.Dynamic(b,a,c)};L.AGS.Layer.Tiled=L.TileLayer.extend({getTileUrl:function(b){this._adjustTilePoint(b);var a=this._url+"/tile/{z}/{y}/{x}",c=this._getZoomForUrl(),a=a.replace("{s}","").replace("{z}",c).replace("{x}",b.x).replace("{y}",b.y);return"token"in this.options?a+"?token="+this.options.token:a}});L.agsTileLayer=function(b,a){return new L.AGS.Layer.Tiled(b,a)};L.AGS.Layer.Tiled.Dynamic=L.AGS.Layer.Tiled.extend({defaultParams:{format:"png8",transparent:!0,nocache:!1,f:"image",bboxSR:102100},initialize:function(b,a){this._url=b;this._layerParams=L.Util.extend({},this.defaultParams);this._layerParams.width=this._layerParams.height=this.options.tileSize;for(var c in a)this.options.hasOwnProperty(c)||(this._layerParams[c]=a[c]);delete this._layerParams.token;this.parseLayers();this.parseLayerDefs();L.Util.setOptions(this,a)},onAdd:function(){L.TileLayer.prototype.onAdd.call(this,
map)},parseLayers:function(){if("undefined"===typeof this._layerParams.layers)delete this._layerParams.layerOption;else{var b=this._layerParams.layerOption||null,a=this._layerParams.layers||null,c="show",d=["show","hide","include","exclude"];delete this._layerParams.layerOption;if(b)-1!=d.indexOf(b)&&(c=b),this._layerParams.layers=c+":"+a;else if(a instanceof Array)this._layerParams.layers=c+":"+a.join(",");else if("string"===typeof a){if(b=a.match(":"))a=a.split(b[0]),Number(a[1].split(",")[0])&&
(-1!=d.indexOf(a[0])&&(c=a[0]),a=a[1]);this._layerParams.layers=c+":"+a}}},parseLayerDefs:function(){if("undefined"!==typeof this._layerParams.layerDefs){var b=this._layerParams.layerDefs,a=[];if(b instanceof Array)for(var c=b.length,d=0;d<c;d++)b[d]&&a.push(d+":"+b[d]);else if("object"===typeof b)for(c in b)a.push(c+":"+b[c]);else{delete this._layerParams.layerDefs;return}this._layerParams.layerDefs=a.join(";")}},getTileUrl:function(b){var a=this.options.tileSize,b=b.multiplyBy(a),a=b.add(new L.Point(a,
a)),b=this._map.unproject(b,this._zoom,!0),a=this._map.unproject(a,this._zoom,!0),b=this._map.options.crs.project(b),a=this._map.options.crs.project(a),a=[b.x,a.y,a.x,b.y].join();this._layerParams.bbox=a;this._layerParams.size=this.options.tileSize+","+this.options.tileSize;this._layerParams.nocache?this._layerParams.nocache=1E16*Math.random():delete this._layerParams.nocache;a=this._url+"/export"+L.Util.getParamString(this._layerParams);"undefined"!==typeof this.options.type&&(a=a+"&type="+this.options.type);
"undefined"!==typeof this.options.token&&(a=a+"&token="+this.options.token);return a}});L.AGS.Security=L.AGS.extend({token:{},options:{},initialize:function(b,a,c){L.Util.setOptions(this,a);this._url=b;this._callback=c;"undefined"!==typeof this.options.username&&"undefined"!==typeof this.options.password?this.fetchToken(this.options.username,this.options.password):this.getUserInfo()},getUserInfo:function(){var b=this,a=document.createElement("div");a.className+="esri_user_info";a.id="esri_user_info";document.body.appendChild(a);var c=document.createElement("form");a.appendChild(c);var d=
document.createElement("input");d.id="esri_login";d.type="text";"undefined"!==typeof this.options.username&&(d.value=this.options.username);c.appendChild(d);d=document.createElement("input");d.id="esri_pass";d.type="password";c.appendChild(d);d=document.createElement("input");d.id="submit";d.type="submit";c.appendChild(d);d=window.innerHeight||document.documentElement.clientHeight;a.style.left=(window.innerWidth||document.documentElement.clientWidth)/2-a.offsetWidth/2+"px";a.style.top=d/2-a.offsetHeight/
2+"px";a.style.visibility="visible";d="getComputedStyle"in window?window.getComputedStyle(a,null).backgroundColor:a.currentStyle.backgroundColor;if("transparent"==d||"rgba(0, 0, 0, 0)"==d)a.style.background="#aaaaaa";"addEventListener"in c?c.addEventListener("submit",function(c){c.preventDefault();var c=document.getElementById("esri_login").value,d=document.getElementById("esri_pass").value;a.style.display="none";document.body.removeChild(a);b.fetchToken(c,d)},!1):c.attachEvent("onSubmit",function(c){c.preventDefault();
var c=document.getElementById("esri_login").value,d=document.getElementById("esri_pass").value;a.style.display="none";document.body.removeChild(a);b.fetchToken(c,d)})},fetchToken:function(b,a){var c=this;this.options.username=b;var d=this._url+"/tokens",i="request=getToken&username="+b+"&password="+a+"&expiration=60",j=function(a,b){window.setToken=function(a){var b;"object"===typeof a&&a.token?b=a.token:"string"===typeof a&&(b=a);a=new Date;c.token={value:b,expiration:+a.setMinutes(a.getMinutes()+
59)};document.body.removeChild(document.getElementById("tokenJsonP"));delete window.setToken;"undefined"!==typeof c._callback&&c._callback()};var b="?"+b+"&f=pjson&callback=setToken",d=document.createElement("script");d.id="tokenJsonP";d.src=a+b;document.body.appendChild(d);setTimeout(function(){"undefined"===typeof c.token.value&&c.getUserInfo("failed login")},5E3)},h=function(a){var b;"object"===typeof a&&a.token?b=a.token:"string"===typeof a&&(b=a);a=new Date;c.token={value:b,expiration:+a.setMinutes(a.getMinutes()+
59)};(b=document.getElementById("tokenJsonP"))&&document.body.removeChild(b);"undefined"!==typeof c._callback&&c._callback()},f=new XMLHttpRequest;f.onreadystatechange=function(){4==f.readyState&&(400==f.status||0==f.status?(f.abort(),j(d,i)):200==f.status||304==f.status?h(f.responseText):403==f.status&&(f.abort(),c.getUserInfo("failed login")))};var l;if("FormData"in window){l=new FormData;for(var i=i.split("&"),k=0;k<i.length;k++){var e=i[k].split("=");l.append(e[0],e[1])}}else l=i;if("XDomainRequest"in
window){var g=new XDomainRequest;g.onerror=function(){g.abort();j(d,i)};g.onload=function(){h(g.responseText)};g.open("POST",d,!0);g.send(l)}else f.open("POST",d,!0),"string"===typeof l&&f.setRequestHeader("Content-type","application/x-www-form-urlencoded"),f.send(l)}});L.AGS.Tools=L.AGS.extend({});L.AGS.Tools.Identify=L.AGS.Tools.extend({options:{f:"json",sr:"4326",layers:"top",returnGeometry:!0,tolerance:1},initialize:function(b,a,c){this._layer=b;this._callback=c;L.Util.setOptions(this,a);this.parseLayerDefs();this.setMapExtent();this.setImageDisplay()},parseGeometry:function(b){if("undefined"===typeof this.options.geometryType)if("string"===typeof b){var a=b.split(",").length;2==a?this.options.geometryType="esriGeometryPoint":4==a&&(this.options.geometryType="esriGeometryEnvelope")}else b instanceof
Array?"number"===typeof b[1][0]?this.options.geometryType="esriGeometryPolyline":b[1][0]instanceof Array&&(this.options.geometryType="esriGeometryPolygon"):"object"===typeof b&&"undefined"!==typeof b.x&&(this.options.geometryType="esriGeometryPoint");this.options.geometry=b},parseLayerDefs:function(){var b=typeof this.options.layerDefs;if("undefined"!==b)if("object"===b&&!(this.options.layerDefs instanceof Array))this.options.layerDefs=JSON.stringify(this.options.layerDefs);else if(this.options.layerDefs instanceof
Array){for(var b={},a=0,c=this.options.layerDefs.length;a<c;a++)this.options.layerDefs[a]&&(b[a]=this.options.layerDefs[a]);this.options.layerDefs=JSON.stringify(b)}},setImageDisplay:function(){if("undefined"===typeof this.options.imageDisplay){var b=this._layer._map.getSize();this.options.imageDisplay=b.x+","+b.y+",96"}},setMapExtent:function(){if("undefined"===typeof this.options.mapExtent){var b=this._layer._map.getBounds();this.options.mapExtent=b._northEast.lng+","+b._southWest.lat+","+b._southWest.lng+
","+b._northEast.lat}},execute:function(b){this.parseGeometry(b);var a=this,c=this._layer._url+"/identify",d=function(c){window.parseResponse=function(c){document.body.removeChild(document.getElementById("getJsonP"));a.findBestFeature(c,b);delete window.parseResponse};this.options.f="pjson";var d=document.createElement("script");d.id="getJsonP";d.src=c+L.Util.getParamString(this.options)+"&callback=parseResponse";document.body.appendChild(d)},i=new XMLHttpRequest;i.onreadystatechange=function(){if(4==
i.readyState)if(400==i.status||0==i.status)d(c,this.options);else if(200==i.status||302==i.status){var h=i.responseText,f=b,f=f.split(","),l=new L.LatLng(f[1],f[0]),k=a._layer._map,h=JSON.parse(h);if(h.results instanceof Array)if(1==h.results.length)if("undefined"!==typeof a._callback)a._callback(h.results[0]);else{var e=h.results[0].geometry;if(e.hasOwnProperty("x")&&e.hasOwnProperty("y")){var g=new L.LatLng(e.y,e.x),j=new L.CircleMarker(g);k.addLayer(j);setTimeout(function(){k.removeLayer(j)},5E3)}else if(e.hasOwnProperty("rings")){for(var g=
[],e=e.rings,f=0,n=e[0].length;f<n;f++)h=new L.LatLng(e[0][f][1],e[0][f][0]),g.push(h);var p=new L.Polygon(g);k.addLayer(p);setTimeout(function(){k.removeLayer(p)},5E3)}}else if(1<h.results.length){console.log("more than 1");for(var r=null,u=1E6,t=null,f=0,n=h.results.length;f<n;f++)if("undefined"!==typeof h.results[f])if(e=h.results[f].geometry,e.hasOwnProperty("x")&&e.hasOwnProperty("y"))g=new L.LatLng(e.y,e.x),g=g.distanceTo(l),g<u&&(r="point",u=g,t=f);else if(e.hasOwnPropety("rings")){for(var g=
[],e=e.rings,m=0,n=e.length;m<n;m++)g.push(new L.LatLng(e[0][m][1],e[0][m][0]));for(var e=!1,o=g.length-1,m=0,n=g.length;m<n;m++){var v=g[m].lat,s=g[m].lng,w=g[o].lat,o=g[o].lng,x=l.lat,q=l.lng;if(s<q&&o>=q||o<q&&s>=q)v+(q-s)/(o-s)*(w-v)<x&&(e=!e);o=m}if(e){r="polygon";t=f;break}}h=h.results[t];if("undefined"!==typeof a._callback)a._callback(h);else if(e=h.geometry,"point"==r)g=new L.LatLng(e.y,e.x),j=new L.CircleMarker(g),k.addLayer(j),setTimeout(function(){k.removeLayer(j)},5E3);else if("polygon"==
r){g=[];e=e.rings;f=0;for(n=e.length;f<n;f++)g.push(new L.LatLng(e[0][f][1],e[0][f][0]));p=new L.Polygon(g);k.addLayer(p);setTimeout(function(){k.removeLayer(p)},5E3)}}}};formData=L.Util.getParamString(this.options).split("?")[1];if("XDomainRequest"in window){var j=new XDomainRequest;j.onerror=function(){j.abort();d(c,this.options)};j.onload=function(){setToken(j.responseText)};j.open("POST",c,!0);j.send(formData)}else i.open("POST",c,!0),"string"===typeof formData&&i.setRequestHeader("Content-type",
"application/x-www-form-urlencoded"),i.send(formData)}});
